<%= render partial: 'spree/admin/shared/product_sub_menu' %>

<%= render partial: 'spree/admin/shared/product_tabs', locals: { current: 'Images' } %>

<% content_for :page_actions do %>
  <li><%= button_link_to Spree.t(:back_to_images_list), admin_product_images_url(@product), icon: 'arrow-left' %></li>
  <% if can?(:create, Spree::VariantImageRule) %>
    <li data-hook="admin_create_variant_image_rule_button">
      <%= button_link_to Spree.t(:new_image), '#', id: 'new-variant-image-rule-image-button', icon: 'plus' %>
    </li>
  <% end %>
<% end %>

<% if can?(:create, Spree::VariantImageRule) %>
  <%= form_for [:admin, @product, @variant_image_rule], html: { multipart: true, class: 'hidden', id: 'new-variant-image-rule-image-form' } do |f| %>
    <fieldset class='no-border-top'>
      <%= f.hidden_field 'option_value_ids', value: @option_value_ids.join(',') %>
      <%= f.fields_for :values, Spree::VariantImageRuleValue.new(variant_image_rule: @variant_image_rule) do |rule_image_form| %>
        <div data-hook="admin_image_form_fields">
          <div class="four columns alpha">
            <div data-hook="file" class="field">
              <%= rule_image_form.label :image_attachment, Spree.t(:filename) %><br>
              <%= rule_image_form.file_field :image_attachment %>
            </div>
          </div>
          <div data-hook="alt_text" class="field omega five columns">
            <%= rule_image_form.label :image_alt, Spree.t(:alt_text) %><br>
            <%= rule_image_form.text_area :image_alt, rows: 4, class: 'fullwidth' %>
          </div>
        </div>
      <% end %>
      <div class="clear"></div>
      <%= render partial: 'spree/admin/shared/new_resource_links' %>
    </fieldset>
  <% end %>
<% end %>

<%= form_tag admin_product_variant_image_rules_path, method: :get, id: 'variant_option_value_selections' do %>
  <fieldset class='no-border-bottom'>
    <legend align="center"><%= Spree.t(:option_value_filters) %></legend>
    <fieldset class='no-border-top'>
      <% @option_types.each do |option_type, option_values| %>
        <div class="field">
          <%= label :option_type_presentation, option_type.presentation %>
          <%= select_tag "ovi[]", options_from_collection_for_select(option_values, :id, :presentation, params[:ovi]), class: 'select2 fullwidth', include_blank: true, id: "#{option_type.name}_option_type_select" %>
        </div>
      <% end %>
      <div class="form-buttons filter-actions actions">
        <%= button Spree.t(:filter_results) %>
      </div>
    </fieldset>
  </fieldset>
<% end %>

<% if @variant_image_rule.values.any? %>
  <table class="index sortable" data-hook="variant_images_table" data-sortable-link="<%= update_positions_admin_product_variant_image_rule_variant_image_rule_values_url(@product, @variant_image_rule) %>">
    <colgroup data-hook="image_colgroup">
      <col style="width: 5%">
      <col style="width: 60%">
      <col style="width: 25%">
      <col style="width: 10%">
    </colgroup>
    <thead>
      <tr data-hook="images_header">
        <th colspan="2"><%= Spree.t(:thumbnail) %></th>
        <th><%= Spree.t(:alt_text) %></th>
        <th class="actions"></th>
      </tr>
    </thead>
    <tbody>
      <% @variant_image_rule.values.each do |rule_value| %>
        <%- image = rule_value.image %>
        <tr id="<%= spree_dom_id rule_value  %>" data-hook="images_row" class="<%= cycle('odd', 'even')%>">
          <td class="no-border" data-hook="image_row_handle">
            <% if can?(:update_positions, image) %>
              <span class="handle"></span>
            <% end %>
          </td>
          <td class='align-center' data-hook="image_row_image">
            <%= link_to image_tag(image.attachment.url(:product)), image.attachment.url(:product), class: "image-row-img", target: "_blank" %>
          </td>
          <td data-hook="image_row_alt">
            <%= image.alt %>
          </td>
          <td class="actions" data-hook="image_row_actions">
            <% if can?(:destroy, image) %>
              <%= link_to_delete image, { url: admin_product_variant_image_rule_variant_image_rule_value_path(@product, @variant_image_rule, rule_value), no_text: true } %>
            <% end %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% end %>
